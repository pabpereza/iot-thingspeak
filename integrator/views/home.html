<!DOCTYPE html>
<html>
    <head>
        <title>Histórico de Temperatura y Humedad de Arnedo, La Rioja</title>
        <!-- Agregar enlace a Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body class="bg-light">
        <div class="container mt-5">
            <h1 class="text-center mb-4">Histórico de Temperatura y Humedad de Arnedo, La Rioja</h1>
            <div class="row mt-5">
                <div class="col-md-6">
                    <canvas id="temperatureChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
            <div class="table-responsive mt-5">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Temperatura (°C)</th>
                            <th>Humedad (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for feed in feeds %}
                        <tr>
                            <td>{{ feed['created_at'] | datetimeformat }}</td>
                            <td>{{ feed['field1'] }}ºC</td>
                            <td>{{ feed['field2'] }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
                // Obtener datos de feeds desde el servidor
                const feeds = JSON.parse(`{{ feeds | tojson | safe }}`);

                // Extraer datos para los gráficos
                const labels = feeds.map(feed => {
                    const date = new Date(feed['created_at']);
                    const year = date.getFullYear().toString().slice(-2); // Obtener los últimos dos dígitos del año
                    const hour = date.getHours(); // Obtener solo la hora
                    return `${hour}:00 - '${year}`; // Formato: hora y año corto
                });
                const temperatures = feeds.map(feed => parseFloat(feed['field1']));
                const humidities = feeds.map(feed => parseFloat(feed['field2']));

                // Configurar el gráfico de temperatura
                const tempCtx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Temperatura (°C)',
                                data: temperatures,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Historial de Temperatura'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Fecha'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperatura (°C)'
                                }
                            }
                        }
                    }
                });

                // Configurar el gráfico de humedad
                const humCtx = document.getElementById('humidityChart').getContext('2d');
                new Chart(humCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Humedad (%)',
                                data: humidities,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Historial de Humedad'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Fecha'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Humedad (%)'
                                }
                            }
                        }
                    }
                });
            </script>
        <!-- Agregar script de Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
